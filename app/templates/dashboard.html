<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ML Inference Dashboard</title>
    <link rel="stylesheet" href="/static/styles.css">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body>
    <h1>ML Inference Service</h1>
    
    <form id="upload-form" action="/predict" method="post" enctype="multipart/form-data">
        <input type="file" name="file" accept=".csv" required>
        <button type="submit">Run Prediction</button>
    </form>

    <h2>Recent Predictions</h2>
    <div id="predictions"></div>

    <h2>Drift Metrics</h2>
    <div id="drift-chart"></div>

<script>
async function fetchDashboardData() {
    try {
        const resp = await fetch("/dashboard/data");
        const json = await resp.json();

        if(json.status === "ok") {
            const data = json.data;

            // Update predictions table
            const predDiv = document.getElementById("predictions");
            if(Array.isArray(data.results) && data.results.length > 0){
                predDiv.innerHTML = "<pre>" + JSON.stringify(data.results, null, 2) + "</pre>";
            } else {
                predDiv.innerHTML = "<p>No recent predictions.</p>";
            }

            // Update drift chart
            const driftContainer = document.getElementById("drift-chart");
            const driftData = data.drift || [];
            const columns = driftData.map(d => d.column);
            const scores = driftData.map(d => Number(d.score));

            const trace = {
                x: columns,
                y: scores,
                type: 'bar',
                marker: {color: 'orange'}
            };

            const layout = {
                title: 'Drift Scores by Column',
                yaxis: {title: 'Score'},
                xaxis: {title: 'Column'}
            };

            Plotly.newPlot(driftContainer, [trace], layout);

        } else {
            console.warn("Dashboard data not available:", json.message);
        }

    } catch(err) {
        console.error("Failed to fetch dashboard data:", err);
    }
}

// Fetch every 10 seconds
fetchDashboardData();
setInterval(fetchDashboardData, 10000);

// File upload handler
document.getElementById("upload-form").addEventListener("submit", async (e) => {
    e.preventDefault();
    const fileInput = e.target.file.files[0];
    if (fileInput) {
        const formData = new FormData();
        formData.append("file", fileInput);

        const response = await fetch("/predict", { method: "POST", body: formData });
        const data = await response.json();
        document.getElementById("predictions").innerHTML =
            `<pre>${JSON.stringify(data.results, null, 2)}</pre>`;
    }
});
</script>
</body>
</html>

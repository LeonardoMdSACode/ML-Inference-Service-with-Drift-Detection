<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ML Inference Dashboard</title>
    <link rel="stylesheet" href="/static/styles.css">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body>
    <h1>ML Inference Service</h1>
    
    <form id="upload-form" action="/predict" method="post" enctype="multipart/form-data">
        <input type="file" name="file" accept=".csv" required>
        <button type="submit">Run Prediction</button>
    </form>

    <h2>Predictions</h2>
    <div id="predictions"></div>

    <h2>Drift Metrics</h2>
    <div id="drift-chart"></div>

<script>
async function fetchResults(csvFile) {
    const formData = new FormData();
    formData.append("file", csvFile);

    const response = await fetch("/predict", { method: "POST", body: formData });
    const data = await response.json();

    document.getElementById("predictions").innerHTML =
        `<pre>${JSON.stringify(data.results, null, 2)}</pre>`;

    const driftContainer = document.getElementById("drift-chart");
    driftContainer.innerHTML = "";

    if (Array.isArray(data.drift)) {
        const cols = data.drift.map(d => d.column);
        const scores = data.drift.map(d => {
            let val = Number(d.score);
            if (!Number.isFinite(val)) val = 0;
            return val;
        });

        Plotly.newPlot(driftContainer, [{
            x: cols,
            y: scores,
            type: "bar"
        }]);
    } else {
        driftContainer.innerHTML =
            "<p>Drift report scheduled. Open the Evidently HTML report.</p>";
    }
}

document.getElementById("upload-form").addEventListener("submit", async (e) => {
    e.preventDefault();
    const fileInput = e.target.file.files[0];
    if (fileInput) {
        await fetchResults(fileInput);
    }
});
</script>
<div id="drift-chart"></div>

<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
async function fetchDashboardData() {
    try {
        const resp = await fetch("/dashboard/data");
        const json = await resp.json();
        if(json.status === "ok") {
            const driftData = json.data.drift;
            const columns = driftData.map(d => d.column);
            const scores = driftData.map(d => d.score);

            const trace = {
                x: columns,
                y: scores,
                type: 'bar',
                marker: {color: 'orange'}
            };

            const layout = {
                title: 'Drift Scores by Column',
                yaxis: {title: 'Score'},
                xaxis: {title: 'Column'}
            };

            Plotly.newPlot('drift-chart', [trace], layout);
        } else {
            console.warn("Dashboard data not available:", json.message);
        }
    } catch(err) {
        console.error("Failed to fetch dashboard data:", err);
    }
}

// Fetch every 10 seconds
fetchDashboardData();
setInterval(fetchDashboardData, 10000);
</script>
</body>
</html>
